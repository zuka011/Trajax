stages:
  - verify
  - publish
  - build
  - pages
  - mirror
  - triggers

include:
  - project: "zurabm/ci-templates"
    ref: v1.4.6
    file:
      - "/python/verify.yml"
      - "/python/publish.yml"

variables:
  RUN_INTEGRATION_TESTS: "true"
  RUN_BENCHMARKS: "true"
  COLLECT_COVERAGE: "true"
  PYPI_PROJECT_NAME: "trajax"
  COVERAGE_SOURCE: "trajax"

benchmark:
  extends: .benchmark-base
  rules:
    - if: "$CI_COMMIT_TAG"
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip benchmark\]/'
      when: never
    - if: '$RUN_VERIFY == "true" && $RUN_BENCHMARKS == "true"'
  script:
    - curl --proto '=https' --tlsv1.2 -sSfL https://bencher.dev/download/install-cli.sh | bash
    - source $HOME/.cargo/env
    - bencher --version
    - echo "BENCHER_API_TOKEN is set? ${BENCHER_API_TOKEN:+yes}"
    - uv run pytest -m 'benchmark and not risk_benchmark' --benchmark-json=benchmark.json
    - >-
      bencher run
      --project trajax
      --token "$BENCHER_API_TOKEN"
      --branch "$CI_COMMIT_REF_NAME"
      --testbed gitlab-ci
      --adapter python_pytest
      --file benchmark.json

coverage:
  extends:
    - .coverage-report-base
  rules:
    - if: "$CI_COMMIT_TAG"
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip coverage\]/'
      when: never
    - if: '$RUN_VERIFY == "true" && $COLLECT_COVERAGE == "true"'
  script:
    - |
      COVERAGE_FILES=""
      [ -f coverage-unit.xml ] && COVERAGE_FILES="$COVERAGE_FILES --file coverage-unit.xml"
      [ -f coverage-integration.xml ] && COVERAGE_FILES="$COVERAGE_FILES --file coverage-integration.xml"
      
      if [ -z "$COVERAGE_FILES" ]; then
        echo "ERROR - No coverage files found" && exit 1
      fi
      
      curl -Os https://cli.codecov.io/latest/linux/codecov
      chmod +x codecov
      ./codecov upload-process $COVERAGE_FILES --token $CODECOV_TOKEN

build-visualizer-cli:
  stage: build
  image: node:22
  needs: []
  script:
    - npm install -g pnpm
    - cd visualizer/core
    - pnpm install --frozen-lockfile
    - pnpm build
  artifacts:
    paths:
      - visualizer/trajax_visualizer/assets/cli.js
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

pages:
  stage: pages
  extends:
    - .base
  script:
    - apt-get update -qq && apt-get install -qq -y nodejs
    - uv run pytest -v -m docs --visualize --notebooks
    - uv run mkdocs build --strict --site-dir public
  artifacts:
    paths:
      - public
      - notebooks
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - job: build-visualizer-cli
      artifacts: true

mirror-github:
  stage: mirror
  image:
    name: alpine/git:latest
    entrypoint: [""]
  needs:
    - job: pages
      artifacts: true
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  script:
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    - cp -r notebooks/ notebooks_copy/
    - git checkout -B main
    - mkdir -p notebooks
    - cp notebooks_copy/*.ipynb notebooks/
    - git add -f notebooks/
    - |
      git diff --cached --quiet || git commit -m "chore: update generated notebooks [skip ci]"
      GITHUB_HOST=$(echo "$GITHUB_REPO_URL" | sed 's|https://||')
      git remote add github "https://oauth2:${GITHUB_PAT}@${GITHUB_HOST}"
      git push github main --force
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success

visualizer:
  stage: triggers
  trigger:
    include: visualizer/.gitlab-ci.yml
  inherit:
    variables: false
  rules:
    - changes:
        - "visualizer/**/*"
      when: always
  variables:
    PYPI_API_TOKEN: $PYPI_API_TOKEN_VISUALIZER
